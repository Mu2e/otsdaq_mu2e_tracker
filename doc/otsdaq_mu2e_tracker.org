#
* ------------------------------------------------------------------------------
* startup checks                                                             
** 1. check version of the DTC firmware                                      
#+begin_src
mu2etrk@mu2edaq09:~/test_stand/pasha_018>my_cntl read 0x9004
0x23080819
sts=0
#+end_src
** 2. check locked fibers                                                    
#+begin_src 
mu2etrk@mu2edaq09:~/test_stand/pasha_018>my_cntl read 0x9140
0x00000011
sts=0
#+end_src
** 3. check ROC pattern readout                                              
#+begin_src                                                                   
mu2etrk@mu2edaq09:~/test_stand/pasha_018>srcs/otsdaq_mu2e_tracker/scripts/var_pattern_config.sh 0 0
 
Disabling EWMs
sts=0
EWM deltaT set to 0x00000000 sts=0
 
Resetting 0
Configuring link 0 to send patterns
Configuring STATUS_BIT in MODE 0::
 ie STATUS_BIT=0x55
... now sleep for 2 seconds
mu2etrk@mu2edaq09:~/test_stand/pasha_018>mu2eUtil -q 10 -N buffer_test -D 600 -n 3
08-23 08:34:05.384310                      DTC_Registers     INFO DTC_Registers(...): DTC Sim Mode is NoCFO
08-23 08:34:05.384426                      DTC_Registers     INFO DTC_Registers(...): DTC ID is 1
08-23 08:34:05.384446                      DTC_Registers     INFO SetSimMode(...): Initializing device, sim mode is NoCFO
08-23 08:34:05.398122                            DTC.cpp     INFO DTC(...): CONSTRUCTOR
08-23 08:34:05.404393                           mu2eUtil     INFO buffer_test(): Buffer Read 0
08-23 08:34:05.404436                           mu2eUtil     INFO (...): Buffer reports DMA size of 112 bytes. Device driver reports read of 112 bytes,
08-23 08:34:05.410149                          DTC_Types     INFO PrintBuffer(...): 0x000000: 0070 0000 0000 0000 0068 0000 0013 0000 
08-23 08:34:05.410175                          DTC_Types     INFO PrintBuffer(...): 0x000010: 0000 ff01 ffff ffff 0000 0000 0100 0000 
08-23 08:34:05.410182                          DTC_Types     INFO PrintBuffer(...): 0x000020: 0050 0000 0013 0000 0000 ff01 ffff ffff 
08-23 08:34:05.410188                          DTC_Types     INFO PrintBuffer(...): 0x000030: 0000 0000 0000 0000 0000 0000 0000 01ee 
08-23 08:34:05.410193                          DTC_Types     INFO PrintBuffer(...): 0x000040: 0030 8050 0002 0013 0000 0000 0055 0000 
08-23 08:34:05.410198                          DTC_Types     INFO PrintBuffer(...): 0x000050: 0000 0000 0001 0000 0002 0000 0003 0000 
08-23 08:34:05.410203                          DTC_Types     INFO PrintBuffer(...): 0x000060: 0004 0000 0005 0000 0006 0000 0007 0000 
08-23 08:34:05.410213                           mu2eUtil     INFO buffer_test(): Buffer Read 1
08-23 08:34:05.410220                           mu2eUtil     INFO (...): Buffer reports DMA size of 144 bytes. Device driver reports read of 144 bytes,
08-23 08:34:05.410227                          DTC_Types     INFO PrintBuffer(...): 0x000000: 0090 0000 0000 0000 0088 0000 0014 0000 
08-23 08:34:05.410233                          DTC_Types     INFO PrintBuffer(...): 0x000010: 0000 ff01 ffff ffff 0000 0000 0100 0000 
08-23 08:34:05.410238                          DTC_Types     INFO PrintBuffer(...): 0x000020: 0070 0000 0014 0000 0000 ff01 ffff ffff 
08-23 08:34:05.410243                          DTC_Types     INFO PrintBuffer(...): 0x000030: 0000 0000 0000 0000 0000 0000 0000 01ee 
08-23 08:34:05.410249                          DTC_Types     INFO PrintBuffer(...): 0x000040: 0050 8050 0004 0014 0000 0000 0055 0000 
08-23 08:34:05.410254                          DTC_Types     INFO PrintBuffer(...): 0x000050: 0008 0000 0009 0000 000a 0000 000b 0000 
08-23 08:34:05.410259                          DTC_Types     INFO PrintBuffer(...): 0x000060: 000c 0000 000d 0000 000e 0000 000f 0000 
08-23 08:34:05.410264                          DTC_Types     INFO PrintBuffer(...): 0x000070: 0010 0000 0011 0000 0012 0000 0013 0000 
08-23 08:34:05.410270                          DTC_Types     INFO PrintBuffer(...): 0x000080: 0014 0000 0015 0000 0016 0000 0017 0000 
08-23 08:34:05.410276                           mu2eUtil     INFO buffer_test(): Buffer Read 2
08-23 08:34:05.410282                           mu2eUtil     INFO (...): Buffer reports DMA size of 176 bytes. Device driver reports read of 176 bytes,
08-23 08:34:05.410288                          DTC_Types     INFO PrintBuffer(...): 0x000000: 00b0 0000 0000 0000 00a8 0000 0015 0000 
08-23 08:34:05.410293                          DTC_Types     INFO PrintBuffer(...): 0x000010: 0000 ff01 ffff ffff 0000 0000 0100 0000 
08-23 08:34:05.410299                          DTC_Types     INFO PrintBuffer(...): 0x000020: 0090 0000 0015 0000 0000 ff01 ffff ffff 
08-23 08:34:05.410304                          DTC_Types     INFO PrintBuffer(...): 0x000030: 0000 0000 0000 0000 0000 0000 0000 01ee 
08-23 08:34:05.410309                          DTC_Types     INFO PrintBuffer(...): 0x000040: 0070 8050 0006 0015 0000 0000 0055 0000 
08-23 08:34:05.410314                          DTC_Types     INFO PrintBuffer(...): 0x000050: 0018 0000 0019 0000 001a 0000 001b 0000 
08-23 08:34:05.410319                          DTC_Types     INFO PrintBuffer(...): 0x000060: 001c 0000 001d 0000 001e 0000 001f 0000 
08-23 08:34:05.410324                          DTC_Types     INFO PrintBuffer(...): 0x000070: 0020 0000 0021 0000 0022 0000 0023 0000 
08-23 08:34:05.410330                          DTC_Types     INFO PrintBuffer(...): 0x000080: 0024 0000 0025 0000 0026 0000 0027 0000 
08-23 08:34:05.410335                          DTC_Types     INFO PrintBuffer(...): 0x000090: 0028 0000 0029 0000 002a 0000 002b 0000 
08-23 08:34:05.410340                          DTC_Types     INFO PrintBuffer(...): 0x0000a0: 002c 0000 002d 0000 002e 0000 002f 0000 
08-23 08:34:05.410346                           mu2eUtil     INFO buffer_test(): Buffer Read 3
08-23 08:34:06.909774                           mu2eUtil     INFO buffer_test(): Total Elapsed Time: 1.5312 s.
Total Init Time: 19.685 ms.
Total Readout Request Time: 6.2187 ms.
Total Read Time: 1.5053 s.
08-23 08:34:06.909829                           mu2eUtil     INFO buffer_test(): Device Init Time: 7.4364 ms.
Device Request Time: 314.7 us.
Device Read Time: 1.4993 s.
08-23 08:34:06.909869                           mu2eUtil     INFO buffer_test(): Total Bytes Written: 0 bytes (0 bytes).
Total Bytes Read: 432 bytes (432 bytes).
08-23 08:34:06.909880                           mu2eUtil     INFO buffer_test(): Total PCIe Rate: 282.13 bytes/s (282 bytes/s)
Read Rate: 286.99 bytes/s (286 bytes/s)
Device Read Rate: 288.13 bytes/s (288 bytes/s)
#+end_src
** 4. check simple event readout                                             
#+begin_src
mu2etrk@mu2edaq09:~/test_stand/pasha_018>root.exe
   ------------------------------------------------------------------
  | Welcome to ROOT 6.28/04                        https://root.cern |
  | (c) 1995-2022, The ROOT Team; conception: R. Brun, F. Rademakers |
  | Built for linuxx8664gcc on May 08 2023, 02:44:07                 |
  | From tags/v6-28-04@v6-28-04                                      |
  | With g++ (GCC) 9.3.0                                             |
  | Try '.help'/'.?', '.demo', '.license', '.credits', '.quit'/'.q'  |
   ------------------------------------------------------------------

root [0] .L srcs/otsdaq_mu2e_tracker/scripts/test_read_data.C 
root [1] test2_read_data(2,100,300,2500,4000,1,2)
08-23 08:49:59.281945                      DTC_Registers     INFO DTC_Registers(...): DTC Sim Mode is NoCFO
08-23 08:49:59.281998                      DTC_Registers     INFO DTC_Registers(...): DTC ID is 1
08-23 08:49:59.282020                      DTC_Registers     INFO SetSimMode(...): Initializing device, sim mode is NoCFO
08-23 08:49:59.294444                            DTC.cpp     INFO DTC(...): CONSTRUCTOR
0x9100: DTC status       : 0x40808404
0x9138: SERDES Reset Done: 0xbfbfbfbf
0x9158: time window      : 0x000007d0
0x91c8: debug packet type: 0x00000000
 --- read event      0 readSuccess:1 timeout:0 nbytes:   176
08-23 08:49:59.323811                          DTC_Types     CRIT PrintBuffer(...): 0x000000: 00b0 0000 0000 0000 00a8 0000 06ec 0000 
08-23 08:49:59.323834                          DTC_Types     CRIT PrintBuffer(...): 0x000010: 0000 ff01 ffff ffff 0000 0000 0100 0000 
08-23 08:49:59.323840                          DTC_Types     CRIT PrintBuffer(...): 0x000020: 0090 0000 06ec 0000 0000 ff01 ffff ffff 
08-23 08:49:59.323846                          DTC_Types     CRIT PrintBuffer(...): 0x000030: 0000 0000 0000 0000 0000 0000 0000 01ee 
08-23 08:49:59.323851                          DTC_Types     CRIT PrintBuffer(...): 0x000040: 0070 8050 0006 06ec 0000 0000 0055 0000 
08-23 08:49:59.323857                          DTC_Types     CRIT PrintBuffer(...): 0x000050: 00ac 1a68 140a 1a21 050a 0041 56aa 2aa5 
08-23 08:49:59.323862                          DTC_Types     CRIT PrintBuffer(...): 0x000060: a955 155a 56aa 2aa5 a955 155a 56aa 2aa5 
08-23 08:49:59.323868                          DTC_Types     CRIT PrintBuffer(...): 0x000070: 00ac e96b 1416 e921 0516 0041 56aa 2aa5 
08-23 08:49:59.323873                          DTC_Types     CRIT PrintBuffer(...): 0x000080: a955 155a 56aa 2aa5 a955 155a 56aa 2aa5 
08-23 08:49:59.323879                          DTC_Types     CRIT PrintBuffer(...): 0x000090: 00ac b86b 1423 b821 0523 0041 a955 155a 
08-23 08:49:59.323884                          DTC_Types     CRIT PrintBuffer(...): 0x0000a0: 56aa 2aa5 a955 155a 56aa 2aa5 a955 155a 
DTC status       : 0x40808404
debug packet type: 0x00000000
 --- read event      1 readSuccess:1 timeout:0 nbytes:   176
08-23 08:49:59.334384                          DTC_Types     CRIT PrintBuffer(...): 0x000000: 00b0 0000 0000 0000 00a8 0000 06fd 0000 
08-23 08:49:59.334396                          DTC_Types     CRIT PrintBuffer(...): 0x000010: 0000 ff01 ffff ffff 0000 0000 0100 0000 
08-23 08:49:59.334402                          DTC_Types     CRIT PrintBuffer(...): 0x000020: 0090 0000 06fd 0000 0000 ff01 ffff ffff 
08-23 08:49:59.334408                          DTC_Types     CRIT PrintBuffer(...): 0x000030: 0000 0000 0000 0000 0000 0000 0000 01ee 
08-23 08:49:59.334413                          DTC_Types     CRIT PrintBuffer(...): 0x000040: 0070 8050 0006 06fd 0000 0000 0055 0000 
08-23 08:49:59.334418                          DTC_Types     CRIT PrintBuffer(...): 0x000050: 00ac 4be8 140b 4b9b 040b 0041 a955 155a 
08-23 08:49:59.334424                          DTC_Types     CRIT PrintBuffer(...): 0x000060: 56aa 2aa5 a955 155a 56aa 2aa5 a955 155a 
08-23 08:49:59.334429                          DTC_Types     CRIT PrintBuffer(...): 0x000070: 00ac 1ae8 1418 1a9b 0418 0041 56aa 2aa5 
08-23 08:49:59.334434                          DTC_Types     CRIT PrintBuffer(...): 0x000080: a955 155a 56aa 2aa5 a955 155a 56aa 2aa5 
08-23 08:49:59.334439                          DTC_Types     CRIT PrintBuffer(...): 0x000090: 00ac e9e8 1424 e99b 0424 0041 56aa 2aa5 
08-23 08:49:59.334444                          DTC_Types     CRIT PrintBuffer(...): 0x0000a0: a955 155a 56aa 2aa5 a955 155a 56aa 2aa5 
DTC status       : 0x40808404
debug packet type: 0x00000000
08-23 08:49:59.334624                            DTC.cpp     INFO ~DTC(): DESTRUCTOR
root [2] .q
#+end_src
** after that can proceed with OTS
* ------------------------------------------------------------------------------
* reading data (from Monica)
* ------------------------------------------------------------------------------
* 1) after each DIGIs power up, run control_ROC.py on trackerpi1             
1. start control_ROC.py on the PI
   1.a : let serial drives commands to DIGI
   1.b : do alignment, what is alignment ?
   1.c : read smth, why ?
   1.d : in the end, let fiber drive commands to DIGI
#+begin_src     set_digi_rw -s 1                                             
mu2e@trackerpi1:~/trackerScripts $ python3 control_ROC.py /dev/ttyUSB0 115200
reading
Waiting for ARM to connect
==========================
('Connected to ARM on', '/dev/ttyUSB0')
set_digi_rw -s 1
 ** Enabling DIGI signals via serial. Remember to disable with -s 0 to let fiber drive them again!!
(94, 1)
{'Enable/disable DIGI signals via SERIAL/FIBER with -s 1/0. Reading back: ': 1}
Ending...
#+end_src
#+begin_src  ## these are commands issued at the control_ROC.py prompt (may be invisible)
set_digi_rw -s 1
find_alignment
# enable all channels
# read -a 4 -t 0 -s 1 -l 8 -T 10 -m 3 -p 1 -C FFFFFFFF -D FFFFFFFF -E FFFFFFFF
# enable just one channel per lane
read -a 4 -t 0 -s 1 -l 8 -T 10 -m 3 -p 1 -C 0  -D 1400 -E 88000000
# enable 32 channels
read -a 4 -t 0 -s 1 -l 8 -T 10 -m 3 -p 1 -C 0  -D 0 -E FFFFFFFF
set_digi_rw -s 0
#+end_src
* setting the pulser frequency (Richie)                                      
-  60 kHz: digi_rw -h 0 -a 85 -d 1 -w 1   # 31.29 MHz / (2**9+1) = 60.9941520468 kHz)
- 250 kHz: digi_rw -h 0 -a 85 -d 0 -w 1   # 31.29 MHz / (2**7+1) = 242.558139535 kHz)

corresponding distance between the two consecutive pulses :
|-----------------+-----------+-----------|
| expected (usec) | 16.395014 | 4.1227229 |
| observed (usec) | 16.394982 | 4.1227156 |
|-----------------+-----------+-----------|

* control_ROC.py commands                                                    
** digi_rw                                                                   
    - digi_rw -h 2 -a 2
    - digi_rw -h 2 -a 1
    - digi_rw -h 2 -a 0
    - digi_rw -h 15 -a 16 -d 2 -w 1
    - digi_rw -h 15 -a 15 -d 31 -w 1 
    - digi_rw -h 9 -a d -d b -w 1

** find_alignment                                          
** set_preamp_thresh                                                         
    - set_preamp_thresh -c 91 -d 350 -hv 1
    - set_preamp_thresh -c 91 -d 350 -hv 0
    - set_preamp_thresh -c 91 -d 400 -hv 1
    - set_preamp_thresh -c 45 -d 420 -hv 0

** measure_thresholds [-c channel]
    - measure_thresholds -c 91 : channel 91
** pulser_on -c 3 -d 10000 -y 200                                            
    -c 3 : (divide by 8) : pulse channel 91
** readDeviceID                                                              
#+begin_src 
readDeviceID
(13, 52)
{'BackLevelVer': '0x0000',
 'DesignInfo': '0x000000000000000000000000000000000000000000000000000000434f52f41f',
 'DesignVer': '0x0000',
 'DeviceSerial': '0x5a71cc9fee9731be3f0fbd0452b0364b'}

('DRAC ROC ID #', '5a71c')
#+end_src
** readSPI : no parameters
** set_digi_rw                                                              
    set_digi_rw -s 1 : enable  commands over the serial connection
    set_digi_rw -s 0 : disable commands over the serial connection
** rates [-c channel]
    - if channel is not specified, all channels
    - rates -c 91 : rate in the channel # 91
** read                    
    - read -a 0 -t 3 -s 1 -l 8 -T 10 -m 3 -p 0 -C 0 -D 0 -E 08000000 : enable channel 91
   
    -m 3   : mode  ... need -m 3 for internal pulser
    -p 0/1 : 0: 
    -t     : triggering 
    channels go as follows -C : first 32, -D : next 32, -E: last 32

   - read -a 0 -t 0 -s 1 -l 8 -T 10 -m 0 -p 0

** examples of the control_ROC.py output                                     
#+begin_src                   find_alignment                                 
mu2e@trackerpi1:~/trackerScripts $ python3 control_ROC.py /dev/ttyUSB0 115200
reading
Waiting for ARM to connect
==========================
('Connected to ARM on', '/dev/ttyUSB0')
set_digi_rw -s 1
 ** Enabling DIGI signals via serial. Remember to disable with -s 0 to let fiber drive them again!!
(94, 1)
{'Enable/disable DIGI signals via SERIAL/FIBER with -s 1/0. Reading back: ': 1}
find_alignment
(103, 159)
('EyeMonitorWidth', 4)
('IfPatternCheck', 1)
 ******   Iteration 0   ******
ADCPhase 0                | Ailgnment        | Bitslip          | Pttn 0x263
ADC#     Straw#   Active  | Complete Error   | Done     Step    | Fail    
-----------------------------------------------------------------------------------
0        91       *       | *                | *        8       |         
1        85       *       | *                | *        8       |         
2        79       *       | *                | *        8       |         
3        73       *       | *                | *        7       |         
4        67       *       | *                | *        8       |         
5        61       *       | *                | *        8       |         
6        55       *       | *                | *        8       |         
7        49       *       | *                | *        8       |         
-----------------------------------------------------------------------------------
8        43       *       | *                | *        8       |         
9        37       *       | *                | *        8       |         
10       31       *       | *                | *        8       |         
11       25       *       | *                | *        8       |         
12       19       *       | *                | *        8       |         
13       13       *       | *                | *        8       |         
14       7        *       | *                | *        9       |         
15       1        *       | *                | *        9       |         
-----------------------------------------------------------------------------------
16       90       *       | *                | *        5       |         
17       84       *       | *                | *        6       |         
18       78       *       | *                | *        6       |         
19       72       *       | *                | *        6       |         
20       66       *       | *                | *        6       |         
21       60       *       | *                | *        6       |         
22       54       *       | *                | *        6       |         
23       48       *       | *                | *        5       |         
-----------------------------------------------------------------------------------
24       42       *       | *                | *        6       |         
25       36       *       | *                | *        6       |         
26       30       *       | *                | *        6       |         
27       24       *       | *                | *        6       |         
28       18       *       | *                | *        6       |         
29       12       *       | *                | *        6       |         
30       6        *       | *                | *        7       |         
31       0        *       | *                | *        7       |         
-----------------------------------------------------------------------------------
32       93       *       | *                | *        8       |         
33       87       *       | *                | *        8       |         
34       81       *       | *                | *        8       |         
35       75       *       | *                | *        7       |         
36       69       *       | *                | *        8       |         
37       63       *       | *                | *        8       |         
38       57       *       | *                | *        8       |         
39       51       *       | *                | *        8       |         
-----------------------------------------------------------------------------------
40       45       *       | *                | *        8       |         
41       39       *       | *                | *        8       |         
42       33       *       | *                | *        8       |         
43       27       *       | *                | *        8       |         
44       21       *       | *                | *        8       |         
45       15       *       | *                | *        8       |         
46       9        *       | *                | *        9       |         
47       3        *       | *                | *        9       |         
-----------------------------------------------------------------------------------
48       44       *       | *                | *        5       |         
49       38       *       | *                | *        6       |         
50       32       *       | *                | *        6       |         
51       26       *       | *                | *        6       |         
52       20       *       | *                | *        6       |         
53       14       *       | *                | *        6       |         
54       8        *       | *                | *        6       |         
55       2        *       | *                | *        5       |         
-----------------------------------------------------------------------------------
56       92       *       | *                | *        6       |         
57       86       *       | *                | *        6       |         
58       80       *       | *                | *        6       |         
59       74       *       | *                | *        6       |         
60       68       *       | *                | *        6       |         
61       62       *       | *                | *        6       |         
62       56       *       | *                | *        7       |         
63       50       *       | *                | *        7       |         
-----------------------------------------------------------------------------------
64       47       *       | *                | *        8       |         
65       41       *       | *                | *        8       |         
66       35       *       | *                | *        8       |         
67       29       *       | *                | *        7       |         
68       23       *       | *                | *        8       |         
69       17       *       | *                | *        8       |         
70       11       *       | *                | *        8       |         
71       5        *       | *                | *        8       |         
-----------------------------------------------------------------------------------
72       95       *       | *                | *        8       |         
73       89       *       | *                | *        8       |         
74       83       *       | *                | *        8       |         
75       77       *       | *                | *        8       |         
76       71       *       | *                | *        8       |         
77       65       *       | *                | *        8       |         
78       59       *       | *                | *        9       |         
79       53       *       | *                | *        9       |         
-----------------------------------------------------------------------------------
80       46       *       | *                | *        5       |         
81       40       *       | *                | *        6       |         
82       34       *       | *                | *        6       |         
83       28       *       | *                | *        6       |         
84       22       *       | *                | *        6       |         
85       16       *       | *                | *        6       |         
86       10       *       | *                | *        6       |         
87       4        *       | *                | *        5       |         
-----------------------------------------------------------------------------------
88       94       *       | *                | *        6       |         
89       88       *       | *                | *        6       |         
90       82       *       | *                | *        6       |         
91       76       *       | *                | *        6       |         
92       70       *       | *                | *        6       |         
93       64       *       | *                | *        6       |         
94       58       *       | *                | *        7       |         
95       52       *       | *                | *        7       |         
read -a 4 -t 0 -s 1 -l 8 -T 10 -m 3 -p 1 -C FFFFFFFF -D FFFFFFFF -E FFFFFFFF
('OPENING FILE', 'run_73.txt')
SETTING MODE TO  3
(105, 35)
{'AdcMode': 4,
 'Ch_mask1': '0b11111111111111111111111111111111',
 'Clock': 99,
 'EnablePulser': 1,
 'Mode': 0,
 'NumLookback': 8,
 'NumSamples': 1,
 'NumTriggers': 10,
 'TdcMode': 0,
 'TdcString': b'PULSER\x00\x00',
 'digi_read(0xb)': '0b1111111111111111',
 'digi_read(0xc)': '0b1',
 'digi_read(0xd)': '0b1111111111111111',
 'digi_read(0xe)': '0b1111111111111111'}
5
{'TriggerCount': 0, 'TriggerCountMatchNumTriggers': 0}
set_digi_rw   â€“s 0
 ** Disabling DIGI signals via serial, fiber is used by default.
(94, 1)
{'Enable/disable DIGI signals via SERIAL/FIBER with -s 1/0. Reading back: ': 0}
^CEnding...
#+end_src
#+begin_src                   readSPI                                        
set_digi_rw -s 1
readSPI
(10, 72)
{'A0': 872,
 'A1': 996,
 'A2': 1948,
 'A3': 980,
 'ADCSPARE': 0.89,
 'CALPCBTEMP': 38.99,
 'CAL_RAIL_1.8V(mV)': '1837.250',
 'CAL_RAIL_1V(mV)': '1045.625',
 'CAL_RAIL_2.5V(mV)': '2583.250',
 'CAL_TEMP(CELSIUS)': '35.9750',
 'HVPCBTEMP': 36.42,
 'HV_RAIL_1.8V(mV)': '1839.000',
 'HV_RAIL_1V(mV)': '1048.000',
 'HV_RAIL_2.5V(mV)': '2581.625',
 'HV_TEMP(CELSIUS)': '34.7250',
 'I1.2': 2.18,
 'I1.8CAL': 2.23,
 'I1.8HV': 2.01,
 'I2.5': 0.83,
 'I3.3': 0.46,
 'ICAL5.0': 0.06,
 'IHV5.0': 0.06,
 'ROCPCBTEMP': 24.49,
 'ROC_RAIL_1.8V(mV)': '1827.750',
 'ROC_RAIL_1V(mV)': '1035.875',
 'ROC_RAIL_2.5V(mV)': '2570.750',
 'ROC_TEMP(CELSIUS)': '30.6000',
 'RTD': 1.74,
 'V1.0': 1.06,
 'V1.8CAL': 1.84,
 'V1.8HV': 1.82,
 'V2.5': 2.57,
 'V3.3': 6.59,
 'V3.3HV': 3.31,
 'VCAL5.0': 4.87,
 'VDMBHV5.0': 4.88}
set_digi_rw -s 0
#+end_src 
* ROC channel map (Vadim)                                                    
  https://github.com/vlrusu/ROC/blob/f8de12e250585317e4ef082cf9a7a6602be15082/utils.c#L20
* 2) on mu2edaq09, configure the ROC to receive data from all 4 lanes        
   
    15 = 0x1111 means ROC1/ROC/CAL1/CAL0 lanes are all enabled
    and clear counters in ROC logic which saw stuff during the -read command)

#+begin_src
./srcs/otsdaq_mu2e_tracker/scripts/var_link_config.sh 0 15
./srcs/otsdaq_mu2e_tracker/scripts/var_read_all.sh 0          # must return register 18 = 0xf00, ie all DIGIs FIFOs are empty
#+end_src

* 3) after taking some data DREQ and before sending next DREQs               

if the ROCFIFOs are empty (ie reg. 18 returns 0xf0X) are the end of run, just issue:

#+begin_src
./digi_clear.sh LANE_NO
#+end_src 

if register 18 reads some FIFOs not empty (ie something other than 0xf00), issue 

#+begin_src 
./rocfifo_clear.sh LINK_NO
#+end_src 

* 4) helpful DTC counters to read after a run                                

#+begin_src
   ./DTC_counters.sh
#+end_src

example of returned info for a run of 1000 events, with no CRC errors, 1 DREQ missed because of EWM on top of DREQ:

#+begin_quote
 #DTCReq: 0x000003e8 sts=0
 #HB:     0x000003f8 sts=0
 #DataHeader: 0x000003e7 sts=0
 #Payloads:   0x000289ea sts=0
 #CRC errors: 0x00000000 sts=0
#+end_quote
 
before next run, clear TDC counters with

#+begin_src
./DTC_clean.sh
#+end_src

* 5) annex test stands                                                       
** Teststand0 is connected to ttuUSB1                                        
- Power up and down with gpio 25
- No fiber connected (this can change if we want to)
- ROC FlashPro S201QNXR6
- HV DIGI FlashPro:  86129
- To program use ppd-138181
** Teststand1 is connected to ttyUSB0                                        
- Power up and down with gpio 27
- Fiber 1 connected to DTC 
- ROC FlashPro: S2001JWC9O
- CAL DIGI FlashPro: 95232
- To program use ppd-130027
** powering up the test stand                                                
#+begin_src
gpio mode  27 output         # turn on output mode
gpio write 27 1              # set pin 27 output level to high
gpio read  27
gpio write 27 0              # set output level to low 
#+end_src
* 5.5) hit format : https://github.com/bonventre/Digi_FW/blob/master/hdl/fer.vhd
* 5.6) (Richie) there is an active FIXME: time = ((TDC & 0xFFFF00) + (0xFF  - (TDC & 0xFF))) * 5/256. ns 
* 6) VST data format                                                         

- 8x32-bit words OR 256 bits per hit (ie two DTC packets)
- hit data format: 3 words of  timestamp  +  5 words of payload 
- the first 16 bit of the timestamp contains the channels number (presently there is a bug for HV lanes I believe such that bit[15]=1)
- the channel to serdes lane mapping is as per attached file

- an example of the DIGIs readout after

read -a 4 -t 0 -s 1 -l 8 -T 10 -m 3 -p 1 -C 0  -D 1400 -E 88000000

 - 0x00000000: 0x00d0 0x0000 0x0000 0x0000 0x00c8 0x0000 0x1322 0x0000 : DTC_EventHeader ??? *go figure* 
     
    - w0 : 0x00d0 : - total number of bytes 
    - w1 : 0x0000 : - bit 15-08: valid + subsystem ID + reserved *go figure* 
                    - bit 07-04: packet type (0x5)
                    - bit 03-00: ROC link ID
    - w2 : 0x0000 : - bit 15-11: 000000  
                    - bit 10-00: packet count *bits or packets - go figure* 
    - w3 : 0x0000 : - bit 15-08: EWM byte 1, bit 07-00: EWM byte 0 
    - w4 : 0x00c8 : - bit 15-08: EWM byte 3, bit 07-00: EWM byte 2
    - w5 : 0x0000 : - bit 15-08: EWM byte 5, bit 07-00: EWM byte 4
    - w6 : 0x1322 : - bit 15-08: data packet format version                
                    - bit 07-00: data header status                        
                        - bit    00 : 1: data present, 0: no data in the event window
			- bit    01 : 1: ROC didn't receive a heartbit for this window
			- bit    02 : 1: data corrupt
			- bit    03 : 1: more data requests queued
			- bit 04-07 : reserved
    - w7 : 0x0000 : - bit 15-08: event window mode                         
                    - bit 07-00: DTC ID
 - 0x00000010: 0x0000 0xff01 0xffff 0xffff 0x0000 0x0000 0x0100 0x0000 : ???
 - 0x00000020: 0x00b0 0x0000 0x1322 0x0000 0x0000 0xff01 0xffff 0xffff : ???    *go figure* 
    - w0 : 0x00b0 : N(bytes) starting from this point
    - w1 : 0x0000 : 
    - w2 : 0x1322 :
    - w3 : 0x0000 :
    - w4 : 0x0000 :
    - w5 : 0xff01 :
    - w6 : 0xffff :
    - w7 : 0xffff :
 - 0x00000030: 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x0000 0x01ee : ???
 - 0x00000040: 0x0090 0x8050 0x0008 0x1322 0x0000 0x0000 0x0055 0x0000 : data header packet  
    - w0 : 0x0090 : N(bytes) starting from this point
    - w1 : 0x8050 : 
    - w2 : 0x0008 : N(packets) with the hit data
    - w3 : 0x0000 :
    - w4 : 0x0000 :
    - w5 : 0xff01 :
    - w6 : 0xffff :
    - w7 : 0xffff :
 - 0x00000050: 0x005b 0xb660 0x140b 0xb630 0x040b 0x0041 0xa955 0x155a : hit #1 data (two packets per hit)
 - 0x00000060: 0x56aa 0x2aa5 0xa955 0x155a 0x56aa 0x2aa5 0xa955 0x155a : hit #1 data
 - 0x00000070: 0x002a 0xb66a 0x140b 0xb684 0x040b 0x0041 0xa955 0x155a : hit #2 data 
 - 0x00000080: 0x56aa 0x2aa5 0xa955 0x155a 0x56aa 0x2aa5 0xa955 0x155a : hit #2 data 
 - 0x00000090: 0x00de 0xe2ec 0x1306 0xe2df 0x0406 0x0041 0xa955 0x155a : hit #3 data 
 - 0x000000a0: 0x56aa 0x2aa5 0xa955 0x155a 0x56aa 0x2aa5 0xa955 0x155a : hit #3 data 
 - 0x000000b0: 0x00ac 0xe195 0x1406 0xe147 0x0406 0x0041 0x56aa 0x2aa5 : hit #4 data 
 - 0x000000c0: 0xa955 0x155a 0x56aa 0x2aa5 0xa955 0x155a 0x56aa 0x2aa5 : hit #4 data 
* 6.5) channel map - sequence in which the channels are supposed to come     

#+begin_src c++ 
uint8_t hvcal=1; // 1:CAL 2:HV 0:both

uint8_t channel_map[96] = { 
91,85,79,73,67,61,55,49,
43,37,31,25,19,13, 7, 1,
90,84,78,72,66,60,54,48,
42,36,30,24,18,12, 6, 0,
93,87,81,75,69,63,57,51,
45,39,33,27,21,15, 9, 3,

44,38,32,26,20,14, 8, 2,
92,86,80,74,68,62,56,50,
47,41,35,29,23,17,11, 5,
95,89,83,77,71,65,59,53,
46,40,34,28,22,16,10, 4,
94,88,82,76,70,64,58,52};
#+end_src 

- example: CAL lane 0 channel 0: 91 .. 
- bit 91 = 32+32+27
- in control_ROC: -C0 -D0 -E08000000

* 7) slow monitoring - ROC - readSPI over the fiber                          
- <2023-07-12 Wed> instructions by Monica                           
Essentially one needs to do a write to ROC address 258 (0x102) to collect a list of 36 ADCs values, 
and read them all back using a block read of the same address.
In between, there are a couple of diagnostic registers to read that will 
tell you whether the block read is ready to be executed.

How to interpret the 36 numbers read, and the conversion factor needed, 
is contained in the trackerScript/unpacker.py code, under READMONADCS.
The conversion factors listed at the end.

Enjoy!
Monica

1) rocUtil write_register -a 258 -w 0    # instructs microprocessor inside the firmware to read 36 ADC value
2) rocUtil simple_read    -a 128         # should return 0x8000 if 1) was successful
3) rocUtil simple_read    -a 129         # should return 40 (0x28) which is the number of ADC values collected in 1) plus 4
4) rocUtil block_read     -a 258 -c 36   # start a block read of 36 words

Example from DTC1:

mu2etrk@mu2edaq09:~/test_stand/monica_001>rocUtil write_register -a 258 -w 0
07-12 11:31:11.538389                           DTC_Registers     INFO DTC_Registers(...): Sim Mode is NoCFO
07-12 11:31:11.538510                           DTC_Registers     INFO DTC_Registers(...): DTC ID is 1
07-12 11:31:11.538522                           DTC_Registers     INFO SetSimMode(...): Initializing device, sim mode is NoCFO
07-12 11:31:11.551326                                 DTC.cpp     INFO DTC(...): CONSTRUCTOR
07-12 11:31:11.556697                                 DTC.cpp     INFO ~DTC(): DESTRUCTOR

mu2etrk@mu2edaq09:~/test_stand/monica_001>rocUtil simple_read -a 128
0 0x8000
mu2etrk@mu2edaq09:~/test_stand/monica_001>rocUtil simple_read -a 129
0 0x28
#+begin_src <2023-07-12 Wed> ROOT example #1                                 
root [0] DTCLib::DTC dtc(DTCLib::DTC_SimMode_NoCFO,-1,0x1,"");
07-12 14:26:09.959864                           DTC_Registers     INFO DTC_Registers(...): Sim Mode is NoCFO
07-12 14:26:09.959930                           DTC_Registers     INFO DTC_Registers(...): DTC ID is 1
07-12 14:26:09.959945                           DTC_Registers     INFO SetSimMode(...): Initializing device, sim mode is NoCFO
07-12 14:26:09.966937                           DTC_Registers     INFO SetSimMode(...): SKIPPING Initializing device
07-12 14:26:09.972616                                 DTC.cpp     INFO DTC(...): CONSTRUCTOR
root [1] using namespace DTCLib;
root [2] dtc.WriteROCRegister(DTCLib::DTC_Link_0,258,0x0000,false,100);
root [3] auto u = dtc.ReadROCRegister(DTC_Link_0,roc_address_t(128),100); printf("0x%04x\n",u);
0x8000
root [4] auto u = dtc.ReadROCRegister(DTC_Link_0,roc_address_t(129),100); printf("0x%04x\n",u);
0x0028
(int) 7
root [5] std::vector<uint16_t> dat;
root [6] dtc.ReadROCBlock(dat,DTC_Link_0,258,36,false,100)
root [7] printf("0x%04x\n",dat[0]);
0x0048
root [8] printf("0x%04x\n",dat[1]);
0x0080
root [9] printf("0x%04x\n",dat[2]);
0x0128
root [10] printf("0x%04x\n",dat[3]);
0x031c
#+end_src   
#+begin_src <2023-07-12 Wed> ROOT example #2                                 
root [0] .L srcs/otsdaq_mu2e_tracker/scripts/read_spi.C
root [1] read_spi()
07-12 16:56:55.400220                           DTC_Registers     INFO DTC_Registers(...): Sim Mode is NoCFO
07-12 16:56:55.400295                           DTC_Registers     INFO DTC_Registers(...): DTC ID is 1
07-12 16:56:55.400313                           DTC_Registers     INFO SetSimMode(...): Initializing device, sim mode is NoCFO
07-12 16:56:55.406936                           DTC_Registers     INFO SetSimMode(...): SKIPPING Initializing device
07-12 16:56:55.412049                                 DTC.cpp     INFO DTC(...): CONSTRUCTOR
0x8000
0x0028
 0x00000000: 0x0044 0x0080 0x0128 0x0324 0x0bd4 0x046c 0x0804 0x0638 
 0x00000010: 0x0350 0x03fc 0x0798 0x03a0 0x0144 0x013c 0x0328 0x0448 
 0x00000020: 0x0ffc 0x0bc8 0x0478 0x0290 0x012c 0x01c4 0x01e4 0x0868 
 0x00000030: 0x209e 0x391e 0x5075 0x131e 0x20cd 0x398a 0x50ba 0x133b 
 0x00000040: 0x20c0 0x3978 0x50ad 0x131d 
I3.3                 :      0.457
I2.5                 :      0.859
I1.8HV               :      1.987
IHV5.0               :      0.064
VDMBHV5.0            :      4.879
V1.8HV               :      1.824
V3.3HV               :      3.306
V2.5                 :      2.565
A0                   :    848.000
A1                   :   1020.000
A2                   :   1944.000
A3                   :    928.000
I1.8CAL              :      2.175
I1.2                 :      2.122
ICAL5.0              :      0.064
ADCSPARE             :      0.883
V3.3                 :      6.594
VCAL5.0              :      4.860
V1.8CAL              :      1.843
V1.0                 :      1.057
ROCPCBTEMP           :     24.170
HVPCBTEMP            :     36.416
CALPCBTEMP           :     38.994
RTD                  :      1.734
ROC_RAIL_1V(mV)      :   1043.750
ROC_RAIL_1.8V(mV)    :   1827.750
ROC_RAIL_2.5V(mV)    :   2574.625
ROC_TEMP(CELSIUS)    :     32.725
CAL_RAIL_1V(mV)      :   1049.625
CAL_RAIL_1.8V(mV)    :   1841.250
CAL_RAIL_2.5V(mV)    :   2583.250
CAL_TEMP(CELSIUS)    :     34.537
HV_RAIL_1V(mV)       :   1048.000
HV_RAIL_1.8V(mV)     :   1839.000
HV_RAIL_2.5V(mV)     :   2581.625
HV_TEMP(CELSIUS)     :     32.662
07-12 16:56:55.927739                                 DTC.cpp     INFO ~DTC(): DESTRUCTOR
#+end_src
* SPI data over the serial, unpacked                                         
#+begin_src
readSPI
(10, 72)
{'A0': 1012,
 'A1': 1244,
 'A2': 1952,
 'A3': 724,
 'ADCSPARE': 0.83,
 'CALPCBTEMP': 37.38,
 'CAL_RAIL_1.8V(mV)': '1841.250',
 'CAL_RAIL_1V(mV)': '1045.625',
 'CAL_RAIL_2.5V(mV)': '2579.250',
 'CAL_TEMP(CELSIUS)': '34.5375',
 'HVPCBTEMP': 34.48,
 'HV_RAIL_1.8V(mV)': '1839.000',
 'HV_RAIL_1V(mV)': '1044.125',
 'HV_RAIL_2.5V(mV)': '2581.625',
 'HV_TEMP(CELSIUS)': '31.9750',
 'I1.2': 2.15,
 'I1.8CAL': 2.18,
 'I1.8HV': 1.99,
 'I2.5': 0.86,
 'I3.3': 0.48,
 'ICAL5.0': 0.06,
 'IHV5.0': 0.06,
 'ROCPCBTEMP': 25.78,
 'ROC_RAIL_1.8V(mV)': '1827.750',
 'ROC_RAIL_1V(mV)': '1039.750',
 'ROC_RAIL_2.5V(mV)': '2566.750',
 'ROC_TEMP(CELSIUS)': '30.6000',
 'RTD': 1.73,
 'V1.0': 1.06,
 'V1.8CAL': 1.84,
 'V1.8HV': 1.82,
 'V2.5': 2.57,
 'V3.3': 6.59,
 'V3.3HV': 3.31,
 'VCAL5.0': 4.87,
 'VDMBHV5.0': 4.88}
#+end_src
-------------------------------------------------------------------------
* setting up preamps to generate pulses [by Vadim]                           
** 1) run control_ROC, find_alignment, exit                                  
#+begin_src 
python3 control_ROC /dev/ttyUSB1 115200
find_alignment
Ctrl-C
#+end_src 
  exiting at this point is important, otherwise the serial port will not work properly

** 2) run diagnostics                                                        
#+begin_src 
python3 diagnostic.py -m L -f test_20mV.dat -p /dev/ttyUSB1
#+end_src

** 3) login back to control_ROC, measure thresholds                          
#+begin_src 
python3 control_ROC.py /dev/ttyUSB1 115200
measure_thresholds                                
# (this should show the CAL thresholds (third column) about between
# 17-20mV ? there is one channel 28 that is nor working)
pulser_on -c 4 -d 1000 -y 200
# Charge injection works in modulo 8. In other words, -c 0 will pulse channels 0,8,16,etc. 
# In the example above, -c 4 will pulse channels 4, 12,20, etc. 
# Of course, there will be cross talk, so other channels will show, 
# but that can be easily rejected offline. 
#+end_src 
* <2023-08-12 Sat> after mu2edaq09 reboot : source ~/ots_mrb5/chantsDataTestVst.sh
* ------------------------------------------------------------------------------
* reading SPI from ROOT                                                      
#+begin_src  
root [0] .L srcs/otsdaq_mu2e_tracker/scripts/read_spi.C 
root [1] read_spi(2)
08-27 14:52:00.446941                      DTC_Registers     INFO DTC_Registers(...): DTC Sim Mode is NoCFO
08-27 14:52:00.447025                      DTC_Registers     INFO DTC_Registers(...): DTC ID is 1
08-27 14:52:00.447053                      DTC_Registers     INFO SetSimMode(...): Initializing device, sim mode is NoCFO
08-27 14:52:00.459992                            DTC.cpp     INFO DTC(...): CONSTRUCTOR
reg:128 0x8000
reg:129 val:0x0028
 0x00000000: 0x0048 0x0078 0x0138 0x0324 0x0bd4 0x046c 0x0804 0x0638 
 0x00000010: 0x0448 0x0470 0x079c 0x04f0 0x0144 0x0144 0x0328 0x0458 
 0x00000020: 0x0ffc 0x0bd0 0x0478 0x0294 0x0138 0x01c4 0x01c4 0x0864 
 0x00000030: 0x20b0 0x3960 0x50c0 0x1309 0x20a9 0x3940 0x5033 0x1313 
 0x00000040: 0x20a3 0x396e 0x50b2 0x1321 
I3.3                 :      0.483
I2.5                 :      0.806
I1.8HV               :      2.095
IHV5.0               :      0.064
VDMBHV5.0            :      4.879
V1.8HV               :      1.824
V3.3HV               :      3.306
V2.5                 :      2.565
A0                   :   1096.000
A1                   :   1136.000
A2                   :   1948.000
A3                   :   1264.000
I1.8CAL              :      2.175
I1.2                 :      2.175
ICAL5.0              :      0.064
ADCSPARE             :      0.896
V3.3                 :      6.594
VCAL5.0              :      4.873
V1.8CAL              :      1.843
V1.0                 :      1.063
ROCPCBTEMP           :     25.137
HVPCBTEMP            :     36.416
CALPCBTEMP           :     36.416
RTD                  :      1.731
ROC_RAIL_1V(mV)      :   1046.000
ROC_RAIL_1.8V(mV)    :   1836.000
ROC_RAIL_2.5V(mV)    :   2584.000
ROC_TEMP(CELSIUS)    :     31.413
CAL_RAIL_1V(mV)      :   1045.125
CAL_RAIL_1.8V(mV)    :   1832.000
CAL_RAIL_2.5V(mV)    :   2566.375
CAL_TEMP(CELSIUS)    :     32.037
HV_RAIL_1V(mV)       :   1044.375
HV_RAIL_1.8V(mV)     :   1837.750
HV_RAIL_2.5V(mV)     :   2582.250
HV_TEMP(CELSIUS)     :     32.912
08-27 14:52:00.988754                            DTC.cpp     INFO ~DTC(): DESTRUCTOR
#+end_src 
* ------------------------------------------------------------------------------
